---
title: "Query grid as NetCDF"
output: 
  html_notebook:
    code_folding: none
---
Retrieve a grid time series from the Meteomatics Weather API and save it as netcdf files



First you have to import the meteomatics module and the lubridate library

```{r}
library(lubridate)
library(MeteomaticsRConnector)
```

Input here your username and password from your meteomatics profile

```{r}
username <- "r-community"
password <- "Utotugode673"
```

Specify the Path and filename where the file should be saved to
```{r}
dir <- tempdir()
filename <- paste(dir, "grid.nc", sep = "/")
```


Define a startdate and endddate as POSIXct class

```{r}
startdate <- as.POSIXct(format(Sys.time()-hours(24), format="%Y-%m-%d %H:00:00"), tz="UTC")
enddate <- as.POSIXct(format(Sys.time(), format="%Y-%m-%d %H:00:00"), tz="UTC")

interval <- "PT1H"

```

Input here the limiting coordinates for the region of interest

```{r}
lat_N <- 50
lon_W <- -15
lat_S <- 20
lon_E <- 10
resolution <- "0.5,0.5" # or "1,0.5"

```

Choose the model and parameter you want to query
```{r}
parameter <- "evapotranspiration_1h:mm"
model <- "mix"
```

In the following, the request will start. If there is an error in the request as for example a wrong parameter or a date that doesn't exist, you get a message.

```{r}

query_netcdf(filename, startdate, enddate, interval, parameter,
             lat_N, lon_W, lat_S, lon_E, resolution, username, password,
             model = model)
```

To view the NetCDF File  you can use external software such as Panoply, for using NetCDF files in R the ncdf4 package is required. After opening the file you can print the content of the NetCDF file and get the data into a dataframe.

```{r}
require(ncdf4)

nc <- nc_open(filename)
  print(nc)
  data <- ncvar_get(nc = nc)
nc_close(nc)
```

Now you can plot the data you recieved
```{r}
filled.contour(data[,,2], main=paste0("Evaporation | ", startdate))
```

