---
title: "Query lightning data"
output: 
  html_notebook:
    code_folding: none
---
Retrieve a list of lightning strikes from the Meteomatics Weather API


First you have to import the meteomatics module and the lubridate library

```{r}
library(lubridate)
library(MeteomaticsRConnector)
```

Input here your username and password from your meteomatics profile

```{r}
username <- "r-community"
password <- "Utotugode673"
```

Define a startdate and endddate as POSIXct class

```{r}
startdate <- as.POSIXct(format(Sys.time()-hours(24), format="%Y-%m-%d %H:00:00"), tz="UTC")
enddate <- as.POSIXct(format(Sys.time(), format="%Y-%m-%d %H:00:00"), tz="UTC")
```

Input here the limiting coordinates for the region of interest

```{r}
lat_N <- 75
lon_W <- -15
lat_S <- 30
lon_E <- 30
```

In the following, the request will start. If there is an error in the request as for example a wrong parameter or a date that doesn't exist, you get a message.


```{r}
data <- query_lightnings(startdate, enddate, lat_N, lon_W, lat_S, lon_E, username,
                password)
print(head(data))
```

You will get a dataframe containing the four columns "validdate", "lat", "lon" and "stroke_current:kA"

Following Plot gives you an overview of the lightning flashes within the last 24 hours

```{r}
# Load necessary libraries
library(ggplot2)
library(maps)
library(scales)

# Assuming 'data' is your dataframe
# Convert validdate to datetime if not already
data$validdate <- as.POSIXct(data$validdate, origin = "1970-01-01", tz = "UTC")

# Define Europe boundaries
europe_xlim <- c(-30, 25)
europe_ylim <- c(30, 75)

# Base plot with ggplot2
ggplot() +
  borders("world", colour = "gray", fill = "gray") +
  geom_point(data = data, aes(x = lon, y = lat, color = validdate), size = 1) +
  scale_color_gradientn(
    colors = colorRampPalette(c("darkred", "yellow"))(100), 
    name = "",
    breaks = pretty(data$validdate, n = 10),
    labels = function(x) format(x, "%Y-%m-%d %H:%M:%S")
  ) +
  coord_fixed(xlim = europe_xlim, ylim = europe_ylim, ratio = 1) +
  labs(title = "Lightning discharges during the last 24h in Europe",
       x = "Longitude",
       y = "Latitude") +
  theme_minimal()

```

