---
title: "Grid"
output: 
  html_notebook:
    code_folding: none
---
Here you can get a grid of one parameter over a certain area at exaclty one time step. As output you get a dataframe, that contains the latitude,  longitude and the selected parameters as columns


First you have to import the meteomatics module and the lubridate library

```{r}
library(lubridate)
library(MeteomaticsRConnector)
```

Input here your username and password from your meteomatics profile

```{r}
username <- "r-community"
password <- "Utotugode673"
```

Input here the date and the time as class POSIXct.

```{r}
startdate_grid <- ISOdatetime(year = as.integer(strftime(lubridate::today(), '%Y')),
                         month = as.integer(strftime(lubridate::today(), '%m')),
                         day = as.integer(strftime(lubridate::today(), '%d')),
                         hour = 06, min = 00, sec = 00, tz = 'UTC')
```


Choose the parameter you want to get. You can only chose one parameter at a time. Check here which parameters are available: https://www.meteomatics.com/en/api/available-parameters/

```{r}
parameter_grid = list('low_cloud_cover:p')
```

Input here the limiting coordinates of the extract you want to look at. You can also change the resolution.

```{r}
lat_N <- 50
lon_W <- -15
lat_S <- 20
lon_E <- 10
resolution <- "2,2" # or "2x2"
```


Choose the model you want to query. The default value is NULL, meaning that the model mix is selected.

```{r}
model = "mix"
```

There are additional arguments possible for the query:
```{r}
# A character vector containing the ensembles of interest. The default value is NULL. Possible inputs are for example: "median"; "member:5"; "member:1-50"; "member:0"; "mean"; "quantile0.2".
ens_select <- NULL 

# A character vector specifying the interpolation: The default value is NULL. A possible input is: "gradient_interpolation"
interp_select <- NULL

#A character vector containing the cluster of interest. The default value is NULL. Possible inputs are for example: "cluster:1"; "cluster:1-6"
cluster_select <- NULL

#A character vector specifying the treatment of missing weather station values. The default value is NULL. If on_invalid = "fill_with_invalid", missing values are filled with Na.
on_invalid <- NULL
```


In the following, the request will start. If there is an error in the request as for example a wrong parameter or a date that doesn't exist, you get a message.

```{r}
df_grid <- query_grid(datetime = startdate_grid, parameters = parameter_grid, lat_N,  lon_W, lat_S,  lon_E, resolution, model=model, username, password)
print(df_grid)
```
```{r}
# Convert list to a single data frame
df <- do.call(rbind, df_grid)
# Extract values into a matrix
mat <- as.matrix(df[, -1])  # Exclude the first column (lat/lon)
# Optionally, you can set row names and column names
row_names <- df$`lat/lon`
col_names <- as.numeric(colnames(df)[-1])  # Exclude the first column name
rownames(mat) <- row_names
colnames(mat) <- col_names

grid_df <- as.data.frame(mat)
```

Now you can work on the data by using R commands. Here are some examples how you can access to the different datapoints.

```{r}
maximum <- max(grid_df)
minimum <- min(grid_df)
mean <- sapply(grid_df, mean, na.rm = TRUE)


at_this_location = grid_df["46","-15"]
print(at_this_location)
at_this_longitude = grid_df[,"-13"]
print(at_this_longitude)
at_this_latitude = grid_df["46",]
print(at_this_latitude)
```


